<!-- Add better login system -->

<!DOCTYPE html>
<html lang='en'>
<head>
  
<link rel="stylesheet" href="style.css">
<meta charset='utf-8' />

<script src="api.js"></script> 

<link href='fullcalendar/lib/main.css' rel='stylesheet'/> 
  <!-- Calendar code-->
<script src='fullcalendar/lib/main.js'></script>
<script>
  async function loadCalendar(id) {
    var calendarEl = document.getElementById('calendar');
    loadedCalendar = await api().users.getEvents(id)
    parsedEvents = []
    console.log(loadedCalendar)
    loadedCalendar.forEach((calendarEvent) => {
      if (calendarEvent.time.confirmed == true) {
        parsedEvents.push({
          title: calendarEvent.info.name,
          start: calendarEvent.time.start,
          end: calendarEvent.time.finish
        })
      }
    })
    icalData = await api().users.getiCal(id)
    if (!icalData.error) {
      icalData.forEach((icalEvent) => {
        parsedEvents.push(icalEvent)
      })
    }
    console.log(parsedEvents)
    var calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      events: parsedEvents
    });
    calendar.render();
  }
  document.addEventListener('DOMContentLoaded', async function() {
    loadCalendar(3)
  });
  api().users.allUsers().then((users) => {
    users = users.sort((a, b) => {
      if (a.last>b.last) { return -1 } else { return 1 }
    })
    users.forEach((user) => {
      option = document.createElement('option')
      option.value = user.id
      option.innerHTML = `${user.first} ${user.middle?user.middle:""}`
      document.getElementById("loginselect").appendChild(option)
    })
  })
  async function changeAccount() {
    currentUser = await api().users.get(document.getElementById("loginselect").value)
    currentUserId = document.getElementById("loginselect").value
    alert(`Now logging into ${currentUser.last}, ${currentUser.first}${currentUser.middle?" "+currentUser.middle:""}.`)
    loadCalendar(currentUserId)
  }
</script>

</head>

<div class="header">
  <h1> Smart Scheduler </h1>
</div> <!-- remove later??? -->

<body>
  
<div class="header-right">
  <a href="index.html">Home</a>
  <a href="friends.html">Friends</a>
  <a href="events.html">Events</a>
  <a href="me.html">Me</a>
</div>

<div id='calendar' class=calendar></div>

<sidebar style="width: 30%; display: inline-block; position: absolute; margin-top: 150px;" class="sidebar">
  <select name="login" id="loginselect" onchange="changeAccount()">
    
  </select>
  <p>Friends:</p>
  <script>
    var friends = api().users.friends(1)

    friends.forEach((friend) => {
      document.createElement('div'),
    })
  </script>
</sidebar>
  
</body>

</html>